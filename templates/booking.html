<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Taipei Day Trip Website</title>
	<meta name="day trip" content="taipei attractions recommendation">
	<meta name="author" content="Yun">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="/booking.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300&display=swap" rel="stylesheet">
    <style>
        .tpfield {
            height: 40px;
            width: 300px;
            border: 1px solid gray;
            margin: 5px 0;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="overlay" onclick="cancel()"></div>
    <div id="loginDiv">
        <img src="/icon_close.png" onclick="cancel()">
        <div class="loginTopPadding"></div>
        <div class="loginTitle">登入會員帳號</div>
        <input id="loginEmail" type="email" name="loginEmail" placeholder="輸入電子郵件信箱" required>
        <input id="loginPassword" type="password" name="loginPassword" placeholder="輸入密碼" required>
        <button id="loginBtn">登入帳戶</button>
        <div id="loginMessage"></div>
        <div id="loginSignupBlock" onclick="toSignupDiv()">還沒有帳戶？點此註冊</div>
    </div>
    <div id="signupDiv">
        <img src="/icon_close.png" onclick="cancel()">
        <div class="signupTopPadding"></div>
        <div class="signupTitle">註冊會員帳號</div>
        <input id="signupName" type="text" name="signupName" placeholder="輸入姓名" required>
        <input id="signupEmail" type="email" name="signupEmail" placeholder="輸入電子郵件信箱" required>
        <input id="signupPassword" type="password" name="signupPassword" placeholder="輸入密碼" required>
        <input id="signupPasswordCheck" type="password" name="signupPasswordCheck" placeholder="確認密碼" required>
        <button id="signupBtn">註冊新帳戶</button>
        <div id="signupMessage"></div>
        <div id="signupLogInBlock" onclick="toLoginDiv()">已經有帳戶了？點此登入</div>
    </div>

    <div style="height:54px"></div>

    <div class="nav">
	    <div class="navBar">
		    <p class="navText"><a class="indexLink" href="/">台北一日遊</a></p>
		    <ul class="indexMenu">
			    <li><a href="" id="navBooking">預定行程</a></li>
                <li><a onclick="logInOrSignUp()" id="navInUp">登入/註冊</a></li>
		    </ul>
	    </div>
    </div>

    <div class="wrapper">
        <div class="greetings">您好，<span id="bookingUsername"></span>，待預訂的行程如下：</div>
        <div id="withoutBooking">目前沒有任何待預定的行程</div>
        <div id="bookingInfo">
            <div id="attractionPicDiv"><img id="attractionPic"></div>
        </div>
        <div id="attractionInfo" style="width:100%">
            <div class="subHeading" style="margin: 0 0 30px 0;color: #448899;">台北一日遊：<span id="attractionName"></span></div>
            <div class="subHeading" style="margin-bottom: 20px;">日期：<span id="date" style="font-weight: 400;"></span></div>
            <div class="subHeading" style="margin-bottom: 20px;">時間：<span id="time" style="font-weight: 400;"></span></div>
            <div class="subHeading" style="margin-bottom: 20px;">費用：<span style="font-weight: 400;">新台幣&nbsp</span><span id="price" style="font-weight: 400;"></span><span style="font-weight: 400;">&nbsp元</span></div>
            <div class="subHeading" >地點：<span id="address" style="font-weight: 400;"></span></div>
        </div>    
        <div class="delete">
            <img id="deleteIcon" src="/icon_delete.png">
        </div>
        <hr class="hr"/> 
        <div id="contactInfo" style="width:100%">
              
            <div class="heading" style="margin:44px 0 31px 0">您的聯絡資訊</div>
            <div class="subHeading" style="margin-bottom:29px;font-weight: 400;">聯絡姓名：
                <input id="contactName" type="text" name="contactName" value="">
            </div>
            <div class="subHeading" style="margin-bottom:29px;font-weight: 400;">聯絡信箱：
                <input id="contactEmail" type="text" name="contactEmail" value="">
            </div>
            <div class="subHeading" style="margin-bottom:27px;font-weight: 400;">手機號碼：
                <input id="phoneNums" type="text" name="phoneNums">
            </div>
            <div class="heading" style="margin-bottom:40px;font-size: 16px;line-height: 23px;">請保持手機暢通，準時到達，導覽人員將用手機與您聯繫，務必留下正確的聯絡方式</div>
            
        </div>
        <hr class="hr"/> 
        <div id="cardInfo" style="width:100%">
            <div class="heading" style="margin:44px 0 31px 0">信用卡付款資訊</div>
            <div class="tpfield" id="card-number"></div>
            <div class="tpfield" id="card-expiration-date"></div>
            <div class="tpfield" id="card-ccv"></div>
            <!-- <div class="subHeading" style="margin-bottom:29px;font-weight: 400;">卡片號碼：
                <input class="cardNumsGroup" id="cardNums" type="text" name="cardNums" placeholder="**** **** **** ****">
            </div>
            <div class="subHeading" style="margin-bottom:29px;font-weight: 400;">過期時間：
                <input class="expDateGroup" id="expDate" type="text" name="expDate" placeholder="MM/YY">
            </div>
            <div class="subHeading" style="margin-bottom:47px;font-weight: 400;">驗證密碼：
                <input class="validationGroup" id="validation" type="text" name="validation" placeholder="CVV">
            </div> -->
        </div>
        <hr class="hr"/>   
    </div>

    <div id="paymentInfo" class="subHeading">
        <div style="float:right">總價：新台幣<span id="totalPrice"></span><span>元</span></div><br/>
        <button type="submit" class="submitBtn" id="confirmOrder" style="margin-top:25px;float:right">確認訂購並付款</button>
    </div>

    <div id="footer">
        <p id="footerText"><b>COPYRIGHT@2021台北一日遊</b></p>
    </div>

    <script src="/bookingDebounce.js"></script>
    <script src="/logInAndSignUp.js"></script>
    <script src="/bookingOnload.js"></script>
    <script src="/bookingDelete.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://js.tappaysdk.com/tpdirect/v5.9.0"></script>
    <script>
        let primeCode;

        // SetupSDK
        TPDirect.setupSDK(124101, 'app_eb3EyBJM1eSr5JGWJ7PgmGxEWZ34ZVWyhfsnN24D2Dcvn9pnOz2PUEvD2uan', 'sandbox');

        // SetupCard
        TPDirect.card.setup({
            fields: {
                number: {
                    element: '.form-control.card-number',
                    placeholder: '**** **** **** ****'
                },
                expirationDate: {
                    element: document.getElementById('tappay-expiration-date'),
                    placeholder: 'MM / YY'
                },
                ccv: {
                    element: $('.form-control.cvc')[0],
                    placeholder: '後三碼'
                }
            },
            styles: {
                'input': {
                    'color': 'gray'
                },
                'input.ccv': {
                    // 'font-size': '16px'
                },
                ':focus': {
                    'color': 'black'
                },
                '.valid': {
                    'color': 'green'
                },
                '.invalid': {
                    'color': 'red'
                },
                '@media screen and (max-width: 400px)': {
                    'input': {
                        'color': 'orange'
                    }
                }
            }
        })

        // listen for TapPay Field
        TPDirect.card.onUpdate(function (update) {
            /* Disable / enable submit button depend on update.canGetPrime  */
            /* ============================================================ */

            // update.canGetPrime === true
            //     --> you can call TPDirect.card.getPrime()
            // const submitButton = document.querySelector('button[type="submit"]')
            if (update.canGetPrime) {
                // submitButton.removeAttribute('disabled')
                $('button[type="submit"]').removeAttr('disabled')
            } else {
                // submitButton.setAttribute('disabled', true)
                $('button[type="submit"]').attr('disabled', true)
            }

            /* Change card type display when card type change */
            /* ============================================== */

            // cardTypes = ['visa', 'mastercard', ...]
            var newType = update.cardType === 'unknown' ? '' : update.cardType
            $('#cardtype').text(newType)

            /* Change form-group style when tappay field status change */
            /* ======================================================= */

            // number 欄位是錯誤的
            if (update.status.number === 2) {
                setNumberFormGroupToError('.card-number-group')
            } else if (update.status.number === 0) {
                setNumberFormGroupToSuccess('.card-number-group')
            } else {
                setNumberFormGroupToNormal('.card-number-group')
            }

            if (update.status.expiry === 2) {
                setNumberFormGroupToError('.expiration-date-group')
            } else if (update.status.expiry === 0) {
                setNumberFormGroupToSuccess('.expiration-date-group')
            } else {
                setNumberFormGroupToNormal('.expiration-date-group')
            }

            if (update.status.cvc === 2) {
                setNumberFormGroupToError('.cvc-group')
            } else if (update.status.cvc === 0) {
                setNumberFormGroupToSuccess('.cvc-group')
            } else {
                setNumberFormGroupToNormal('.cvc-group')
            }
        })

        // get prime and post data to server
        $('form').on('submit', function (event) {
            event.preventDefault()
            
            // fix keyboard issue in iOS device
            forceBlurIos()
            
            const tappayStatus = TPDirect.card.getTappayFieldsStatus()
            console.log(tappayStatus)

            // Check TPDirect.card.getTappayFieldsStatus().canGetPrime before TPDirect.card.getPrime
            if (tappayStatus.canGetPrime === false) {
                alert('can not get prime')
                return
            }

            // Get prime
            TPDirect.card.getPrime(function (result) {
                if (result.status !== 0) {
                    alert('get prime error ' + result.msg)
                    return
                }
                primeCode = result.card.prime
                alert('get prime 成功，prime: ' + result.card.prime)
            })
        })

        function setNumberFormGroupToError(selector) {
            $(selector).addClass('has-error')
            $(selector).removeClass('has-success')
        }

        function setNumberFormGroupToSuccess(selector) {
            $(selector).removeClass('has-error')
            $(selector).addClass('has-success')
        }

        function setNumberFormGroupToNormal(selector) {
            $(selector).removeClass('has-error')
            $(selector).removeClass('has-success')
        }

        function forceBlurIos() {
            if (!isIos()) {
                return
            }
            var input = document.createElement('input')
            input.setAttribute('type', 'text')
            // Insert to active element to ensure scroll lands somewhere relevant
            document.activeElement.prepend(input)
            input.focus()
            input.parentNode.removeChild(input)
        }

        function isIos() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
    </script>
    <!-- <script src="/order.js"></script> -->
</body>
</html>